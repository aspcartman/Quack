/* Name: main.c
 * Project: EasyLogger
 * Author: Christian Starkjohann
 * Creation Date: 2006-04-23
 * Tabsize: 4
 * Copyright: (c) 2006 by OBJECTIVE DEVELOPMENT Software GmbH
 * License: Proprietary, free under certain conditions. See Documentation.
 * This Revision: $Id$
 */

#ifndef __AVR_ATtiny45__ /* Only for IDEs */
#define __AVR_ATtiny45__
#endif

#include <avr/io.h>
#include <avr/wdt.h>
#include <avr/eeprom.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include <util/delay.h>

#include "usbdrv.h"

/*
Pin assignment:
PB1 = key input (active low with pull-up)
PB3 = analog input (ADC3)
PB4 = LED output (active high)

PB0, PB2 = USB data lines
*/

#define BIT_LED 1
#define BIT_KEY 1

#define UTIL_BIN4(x)        (uchar)((0##x & 01000)/64 + (0##x & 0100)/16 + (0##x & 010)/4 + (0##x & 1))
#define UTIL_BIN8(hi, lo)   (uchar)(UTIL_BIN4(hi) * 16 + UTIL_BIN4(lo))

#ifndef NULL
#define NULL    ((void *)0)
#endif

uchar calibrationDone = 0x0;

/* ------------------------------------------------------------------------- */

const PROGMEM char usbHidReportDescriptor[USB_CFG_HID_REPORT_DESCRIPTOR_LENGTH] = { /* USB report descriptor */
		0x05, 0x01,                    // USAGE_PAGE (Generic Desktop)
		0x09, 0x06,                    // USAGE (Keyboard)
		0xa1, 0x01,                    // COLLECTION (Application)
		0x05, 0x07,                    //   USAGE_PAGE (Keyboard)
		0x19, 0xe0,                    //   USAGE_MINIMUM (Keyboard LeftControl)
		0x29, 0xe7,                    //   USAGE_MAXIMUM (Keyboard Right GUI)
		0x15, 0x00,                    //   LOGICAL_MINIMUM (0)
		0x25, 0x01,                    //   LOGICAL_MAXIMUM (1)
		0x75, 0x01,                    //   REPORT_SIZE (1)
		0x95, 0x08,                    //   REPORT_COUNT (8)
		0x81, 0x02,                    //   INPUT (Data,Var,Abs)
		0x95, 0x01,                    //   REPORT_COUNT (1)
		0x75, 0x08,                    //   REPORT_SIZE (8)
		0x25, 0x65,                    //   LOGICAL_MAXIMUM (101)
		0x19, 0x00,                    //   USAGE_MINIMUM (Reserved (no event indicated))
		0x29, 0x65,                    //   USAGE_MAXIMUM (Keyboard Application)
		0x81, 0x00,                    //   INPUT (Data,Ary,Abs)
		0xc0                           // END_COLLECTION
};

static const PROGMEM uchar keyData[] = {
		0x08,0x15,
		0x01,0x01,
		0x00,0x11,
		0x00,0x12,
		0x00,0x17,
		0x00,0x08,
		0x00,0x13,
		0x00,0x04,
		0x00,0x07,
		0x00,0x37,
		0x00,0x08,
		0x00,0x1b,
		0x00,0x08,
		0x00,0x28,
		0x01,0x01,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x02,0x2d,
		0x02,0x2d,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x38,
		0x00,0x38,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x31,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x02,0x2d,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2c,
		0x02,0x27,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2c,
		0x02,0x27,
		0x02,0x2d,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x28,
		0x00,0x31,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x28,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x28,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x28,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x26,
		0x02,0x12,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x12,
		0x02,0x27,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x02,0x27,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x35,
		0x00,0x35,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x38,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2d,
		0x00,0x2d,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2d,
		0x00,0x34,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x38,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2d,
		0x00,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x35,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x35,
		0x00,0x35,
		0x00,0x2d,
		0x00,0x2d,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x02,0x2d,
		0x02,0x2d,
		0x02,0x2d,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x2d,
		0x00,0x35,
		0x00,0x35,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x35,
		0x00,0x35,
		0x00,0x35,
		0x00,0x35,
		0x00,0x35,
		0x00,0x28,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x2c,
		0x00,0x2c,
		0x00,0x31,
		0x00,0x28,
		0xff, 0xff
};


void usbEventResetReady(void)
{
}

// this gets called when custom control message is received
uchar usbFunctionSetup(uchar data[8])
{
	return 0;
}

static inline void SendKey(uchar modifier, uchar code)
{
	usbSetInterrupt((uchar[2]) { modifier, code }, sizeof(uchar[2]));
}

static inline void KeepAlive()
{
	wdt_reset(); // keep the watchdog happy
	usbPoll();
}

static void SmartWait(uchar seconds)
{
	for (uchar second = 0; second < seconds; ++second)
	{
		for (uchar decisecond = 0; decisecond < 100; ++decisecond)
		{
			KeepAlive();
			_delay_ms(10);
		}
	}
}

#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Wmissing-noreturn"

int main()
{
	DDRB |= 1 << BIT_LED; // LED pin as output
	PORTB ^= 1 << BIT_LED;

	wdt_enable(WDTO_1S); // enable 1s watchdog timer

	usbInit();

	usbDeviceDisconnect(); // enforce re-enumeration
	for (uchar i = 0; i < 250; i++)
	{ // wait 500 ms
		wdt_reset(); // keep the watchdog happy
		_delay_ms(2);
	}
	usbDeviceConnect();

	sei(); // Enable interrupts after re-enumeration

	SmartWait(10);

	uchar finished   = 0x00;
	int        index = 0x0;

	while (1)
	{
		KeepAlive();

		if (finished)
		{
			index    = 0;
			finished = 0x0;
			continue;
		}

		PORTB ^= 1 << BIT_LED;

		uchar modifier = pgm_read_byte(keyData+index);
		uchar code     = pgm_read_byte(keyData+index+1);

		if (modifier == 0xff)
		{
			finished = 0x01;
			continue;
		}
		else if (modifier == 0x01)
		{
			SmartWait(code);
			index += 2;
		}
		else
		{
			while (!usbInterruptIsReady())
			{}
			SendKey(modifier, code);
			index += 2;
			while (!usbInterruptIsReady())
			{}
			SendKey(0x00, 0x00);
			while (!usbInterruptIsReady())
			{}
		}
	}

	return 0;
}

#pragma clang diagnostic pop


